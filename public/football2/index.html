<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=0.4, user-scalable=no">
    <title>Piłkarzyki</title>
    <script src="//cdn.jsdelivr.net/npm/phaser@3.11.0/dist/phaser.js"></script>

</head>

<body>

    <p>Player1 - 5 numpad - strzał, 4 numpad - bieganie , 6 numpad- zatrzymanie</p>
    <p>Player2 - F - strzał, E - bieganie , R - zatrzymanie</p>

    <canvas id="mycanvas"></canvas>
    <br>
    <label for="">Bot:</label>
    <input type="checkbox" onchange="handleBot()" id="botcheckbox">

    <label for="">Mobile:</label>
    <input type="checkbox" onchange="handleMobile()" id="mobilecheckbox">

    <br>

    <br>

    <p id="nx">Nx:</p>
    <p id="ny">Ny:</p>


    <div style="display:flex;align-items:center">
        <canvas id="joy1" style="border:1px solid black"></canvas>
        <button onClick="run()" style="width:100px;height:100px;margin:20px">4</button>
        <button onClick="kickf()" style="width:100px;height:100px;margin:20px">5</button>
        <button onClick="stop()" style="width:100px;height:100px;margin:20px">6</button>



    </div>



    <script src="joystick.js"></script>

    <script>
        let nxglobal = 0;
        let nyglobal = 0;
        const joy = new Joystick("joy1", {
            size: 300,
            knobRadius: 40,
            onMove: (nx, ny, angle) => {
                nxglobal = nx;
                nyglobal = ny;
                document.getElementById("nx").innerText = "Nx: " + nx.toFixed(2);
                document.getElementById("ny").innerText = "Ny: " + ny.toFixed(2);




            }
        });
    </script>

    <script>

        if (localStorage.bot === 'true') {
            document.querySelector('#botcheckbox').checked = true;
        }

        if (localStorage.mobile === 'true') {
            document.querySelector('#mobilecheckbox').checked = true;
        }

        function handleBot() {



            if (localStorage.bot === 'true') {
                localStorage.bot = 'false';
            } else {
                localStorage.bot = 'true';
            }

            location.reload();
        }

        function handleMobile() {
            if (localStorage.mobile === 'true') {
                localStorage.mobile = 'false';
            } else {
                localStorage.mobile = 'true';
            }

            location.reload();
        }


        var config = {
            canvas: document.getElementById('mycanvas'),
            type: Phaser.AUTO,
            width: 800,
            height: 600,
            physics: {
                default: 'arcade',
                arcade: {
                    friction: true,
                    gravity: false,
                    debug: false
                }
            },
            scene: {
                preload: preload,
                create: create,
                update: update
            }
        };

        let game = new Phaser.Game(config);
        let player1;
        let player2;
        let ball;
        let cursors;
        let platforms;
        let scoretext;
        let timetext;
        let player1score = 0;
        let player2score = 0;

        let player1speed = 120;
        let player2speed = 120;
        let czas = 120;
        let endgame = false;
        let once = 1;
        let kick = 0;
        let kick2 = 0;

        let stopper = 0;

        let friction = 0;

        let player1stamina = 100;
        let player2stamina = 100;

        let goesleft = false;
        let goesup = false;
        let goesright = false;
        let goesdown = false;

        let stamina1text = null;







        function preload() {
            this.load.image('grass', '../assets/grass.png');
            this.load.image('ball', '../assets/ball.png');
            this.load.spritesheet('dude', '../assets/dude.png', { frameWidth: 32, frameHeight: 48 });
            this.load.spritesheet('dude2', '../assets/dude2.png', { frameWidth: 32, frameHeight: 48 });
            this.load.image('platform', '../assets/platformwhite.png');
            this.load.image('platform2', '../assets/platformwhite2.png');
            this.load.image('leftbutton', '../assets/leftbutton.png')
        }

        function run() {

            if (player1stamina <= 0) {
                player1.setTint(0xff0000);
                setTimeout(() => {
                    player1.setTint(0xffffff);
                }, 200);
                return;
            }
            player1speed += 30;
            player1stamina -= 10;

            stamina1text.setText('Player1 stamina:' + player1stamina);


            setTimeout(() => {
                player1speed -= 30;
            }, 2000);

        }

        function kickf() {
            player1.kick = true;
        }

        function stop() {
            player1.stopper = 1;

        }

        function create() {
            let self = this;

            // this.physics.arcade.friction = 0.5;
            console.log(this.physics);

            console.log(this.physics.arcade);

            cursors = this.input.keyboard.createCursorKeys();
            this.add.tileSprite(0, 0, game.config.width, game.config.height, 'grass').setOrigin(0);
            scoretext = this.add.text(50, 50, 'Wynik 0:0', { fill: '#ffff00' });
            timetext = this.add.text(150, 50, 'Czas: ' + czas, { fill: '#00ff00' });

            this.velocitytext = this.add.text(400, 40, 'Ball velocity', { fill: '#ffff00' });
            this.stamina1text = this.add.text(100, 70, 'Player1 stamina:' + player1stamina, { fill: '#999999' });
            stamina1text = this.stamina1text;
            this.stamina2text = this.add.text(100, 100, 'Player2 stamina:' + player2stamina, { fill: '#999999' });


            ball = this.physics.add.sprite(400, 300, 'ball').setScale(0.04);
            ball.setCollideWorldBounds(true);

            ball.setVelocityX(0);
            ball.setVelocityY(2000);

            platforms = this.physics.add.staticGroup();

            platforms.create(0, 500, 'platform2');
            platforms.create(0, 100, 'platform2');
            platforms.create(800, 500, 'platform2');
            platforms.create(800, 100, 'platform2');
            platforms.create(0, 15, 'platform').setScale(5, 1).refreshBody();
            platforms.create(0, 585, 'platform').setScale(5, 1).refreshBody();

            player1 = this.physics.add.sprite(100, 450, 'dude');
            player2 = this.physics.add.sprite(700, 450, 'dude2');
            player2.setAlpha(0.9);

            if (localStorage.bot === 'true') {
                player2.x = 750;
                player2.y = 300;
            }

            this.physics.add.collider(platforms, ball);

            this.physics.add.collider(platforms, player1);
            this.physics.add.collider(platforms, player2);

            ball.body.setCircle(ball.width / 2)

            createAnimations(this);

            ball.setBounce(1.1);
            ball.body.setMaxVelocity(700, 700);
            // ball.body.setFriction(100,100)

            let ballcollider = this.physics.add.collider(player1, ball, littleKick);
            let ballcollider2 = this.physics.add.collider(player2, ball, littleKick);


            ballcollider.bounce = 0.1;

            // ballcollider.bodyBounce = 2;
            this.physics.add.collider(player2, ball)
            this.physics.add.collider(player1, player2, null, function () {
                // return false;
            })

            this.time.addEvent({
                delay: 1000,
                loop: true,
                callback: function () {
                    czas -= 1;
                    timetext.setText('Czas:' + czas);
                    if (czas < 0) {
                        endgame = true;
                        self.add.text(400, 300, 'KONIEC GRY', { fill: '#00FF00' });

                    }
                }
            })





            this.input.keyboard.on('keydown', function (event) {

                if (event.key == '4') {
                    run();
                }

                if (event.key == '5') {
                    kickf();
                }

                if (event.key == '6') {
                    stop();
                }

            }, this);

            this.input.keyboard.addListener('keydown_F', function (event) {
                console.log('fsdaddsf');
                player2.kick = 1;

            }, this);

            this.input.keyboard.addListener('keydown_M', function (event) {
                console.log('X');
                stopper = 1;
            }, this);

            this.input.keyboard.addListener('keydown_R', function (event) {
                console.log('X');
                player2.stopper = 1;
            }, this);

            this.input.keyboard.addListener('keydown_N', function (event) {
                if (player1stamina <= 0) {
                    return;
                }
                player1speed += 30;
                player1stamina -= 10;

                this.stamina1text.setText('Player1 stamina:' + player1stamina);


                setTimeout(() => {
                    player1speed -= 30;
                }, 2000);
            }, this);


            this.input.keyboard.addListener('keydown_E', function (event) {
                if (player2stamina <= 0) {
                    return;
                }
                player2speed += 30;
                player2stamina -= 10;

                this.stamina2text.setText('Player2 stamina:' + player2stamina);


                setTimeout(() => {
                    player2speed -= 30;
                }, 2000);
            }, this);

            this.input.keyboard.on('keydown', function (event) {
                if (event.key == 'shift') {
                    player1
                }
            }
            )

            const interval = setInterval(() => {

                if (player1stamina < 100) {
                    player1stamina += 10
                    this.stamina1text.setText('Player1 stamina:' + player1stamina)
                }

                if (player2stamina < 100) {
                    player2stamina += 10
                    this.stamina2text.setText('Player2 stamina:' + player2stamina)
                }
            }, 1000);




        }



        function littleKick(player, ball) {
            // return;



            if (player.stopper) {
                ball.body.velocity.y = ball.body.velocity.y / 10;
                ball.body.velocity.x = ball.body.velocity.x / 10;
            } else if (player.kick) {
                ball.body.velocity.y = ball.body.velocity.y * 5;
                ball.body.velocity.x = ball.body.velocity.x * 5;

            } else {
                // ball.setVelocityX(400);
            }


            setTimeout(() => {
                //   ball.setVelocityX(0);
                // ball.setVelocityY(0);

            }, 1000)


            var angle = Phaser.Math.Angle.Between(player.x, player.y, ball.x, ball.y);

            var angleInDegrees = Phaser.Math.RadToDeg(angle);

            console.log(angleInDegrees);

            player.kick = 0;
            player.stopper = 0;



        }

        function update() {

            if (player1.kick) {
                player1.setTint(0x00ff00);
            }

            if (player2.kick) {
                player2.setTint(0x00ff00);
            }

            if (player1.stopper) {
                player1.setTint(0xffff00);
            }

            if (player2.stopper) {
                player2.setTint(0xffff00);
            }

            if (!player1.kick && !player1.stopper) {
                player1.setTint(0xffffff);

            }

            if (!player2.kick && !player2.stopper) {
                player2.setTint(0xffffff);

            }

            this.velocitytext.setText('x:' + ball.body.x);

            if (endgame) {
                return
            }

            if (ball.x >= (800 - 20) || ball.x <= 20) {
                ball.setVelocityX(0);
                ball.setVelocityY(0);



                player1win = 0;
                player2win = 0;


                let whowin = 0;
                if (ball.x > 100) {
                    player1win = 1;
                }

                if (ball.x < 100) {
                    player2win = 1;
                }

                if (once) {
                    player1score += player1win;
                    player2score += player2win;
                    once = 0;
                }

                // ball.y = 1000;


                setTimeout(() => {

                    let factor = 1;
                    if (Math.random() > 0.5) {
                        factor = -1;
                    }
                    ball.x = 400;
                    ball.y = 300;
                    ball.setVelocityX(Math.random() * 400 * factor);
                    ball.setVelocityY(Math.random() * 400 * factor);
                    once = 1;



                    scoretext.setText('Wynik ' + player1score + ':' + player2score);
                }, 1000)


            }

            var keyboard = this.input.keyboard;

            if (cursors.left.isDown || goesleft) {
                player1.setVelocityX(-player1speed);
                player1.anims.play('left', true);

            }
            else if (cursors.right.isDown || goesright) {
                player1.setVelocityX(player1speed);
                player1.anims.play('right', true);
            }
            else {
                if (!nxglobal) {
                    player1.setVelocityX(0);
                }
            }

            if (localStorage.bot !== 'true') {
                if (keyboard.addKey('A').isDown) {
                    player2.setVelocityX(-player2speed);
                    player2.anims.play('left2', true);

                }
                else if (keyboard.addKey('D').isDown) {
                    player2.setVelocityX(player2speed);
                    player2.anims.play('right2', true);
                }
                else {
                    player2.setVelocityX(0);
                }
            }





            if (cursors.up.isDown || goesup || nyglobal < 0) {
                player1.setVelocityY(-player1speed);
            } else

                if (cursors.down.isDown || goesdown || nyglobal > 0) {
                    player1.setVelocityY(player1speed);
                } else

                    if (cursors.up.isUp) {
                        player1.setVelocityY(0);

                    } else

                        if (cursors.down.isUp) {
                            if (!nyglobal) {
                                player1.setVelocityY(0);
                            }

                        }

            if (nxglobal) {
                player1.setVelocityX(nxglobal * player1speed);
            }

            if (nyglobal) {
                player1.setVelocityY(nyglobal * player1speed);
            }

            if (nxglobal > 0) {
                player1.anims.play('right', true);
            }

            if (nxglobal < 0) {
                player1.anims.play('left', true);
            }


            if (localStorage.bot !== 'true') {

                if (keyboard.addKey('W').isDown) {
                    player2.setVelocityY(-player2speed);
                } else

                    if (keyboard.addKey('S').isDown) {
                        player2.setVelocityY(player2speed);
                    } else

                        if (keyboard.addKey('W').isUp) {
                            player2.setVelocityY(0);

                        } else

                            if (keyboard.addKey('S').isUp) {
                                player2.setVelocityY(0);

                            }

            }







            if ((cursors.up.isDown || goesup) && !cursors.left.isDown && !cursors.right.isDown) {
                player1.anims.play('right', true);
            }

            if (!cursors.up.isDown && !cursors.left.isDown && !cursors.right.isDown && !cursors.down.isDown && !goesleft && !goesright && !goesdown && !goesup && !nxglobal) {
                player1.anims.play('turn');
            }

            if (keyboard.addKey('W').isDown && !keyboard.addKey('D').isDown && !keyboard.addKey('A').isDown) {
                player2.anims.play('right2', true);
            }

            if (!keyboard.addKey('W').isDown && !keyboard.addKey('A').isDown && !keyboard.addKey('D').isDown && !keyboard.addKey('A').isDown) {
                player2.anims.play('turn2');
            }

            // this.physics.moveToObject(player2, ball, 300);

            // console.log(ball.body.velocity);

            if (ball.body.velocity.y > 0) {
                ball.body.velocity.y -= friction;
            }

            if (ball.body.velocity.y < 0) {
                ball.body.velocity.y += friction;
            }


            if (ball.body.velocity.x > 0) {
                ball.body.velocity.x -= friction;
            }

            if (ball.body.velocity.x < 0) {
                ball.body.velocity.x += friction;
            }

            if (localStorage.bot === 'true') {

                if (player2.x > 750) {
                    // player2.setVelocityX(-10);
                }

                if (player2.x <= 750) {
                    // player2.setVelocityX(0);

                }
                // player2.setDrag(500);

                if (ball.y > player2.y) {

                    player2.setVelocityY(50);
                } else {
                    player2.setVelocityY(-50);
                }

                if (player2.x > 800) {
                    setTimeout(() => {
                        player2.x = 750;
                        player2.setVelocityX(0);
                        player2.y = 300;
                        player1.x = 300;

                        let factor = 1;
                        if (Math.random() > 0.5) {
                            factor = -1;
                        }
                        ball.x = 400;
                        ball.y = 300;
                        ball.setVelocityX(Math.random() * 400 * factor);
                        ball.setVelocityY(Math.random() * 400 * factor);
                        once = 1;

                    }, 1000);
                }

                if (player1.x > 700) {
                    player1.x = 400
                }

            }



        }


        function createAnimations(gameinstance) {
            gameinstance.anims.create({
                key: 'turn',
                frames: [{ key: 'dude', frame: 4 }],
                frameRate: 20
            });

            gameinstance.anims.create({
                key: 'right',
                frames: gameinstance.anims.generateFrameNumbers('dude', { start: 5, end: 8 }),
                frameRate: 5,
                repeat: -1
            });

            gameinstance.anims.create({
                key: 'left',
                frames: gameinstance.anims.generateFrameNumbers('dude', { start: 0, end: 3 }),
                frameRate: 5,
                repeat: -1
            });

            gameinstance.anims.create({
                key: 'turn2',
                frames: [{ key: 'dude2', frame: 4 }],
                frameRate: 20
            });

            gameinstance.anims.create({
                key: 'right2',
                frames: gameinstance.anims.generateFrameNumbers('dude2', { start: 5, end: 8 }),
                frameRate: 5,
                repeat: -1
            });

            gameinstance.anims.create({
                key: 'left2',
                frames: gameinstance.anims.generateFrameNumbers('dude2', { start: 0, end: 3 }),
                frameRate: 5,
                repeat: -1
            });

        }





    </script>


</body>

</html>