<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>RTS</title>
    <script src="//cdn.jsdelivr.net/npm/phaser@3.11.0/dist/phaser.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>

<body>

    <ul id="messages"></ul>
    <form id="form" action="">
        <input id="input" autocomplete="off" /><button>Send</button>
    </form>


    <button id="addplayerbutton"></button>
    <div id="highscorediv"></div>



    <script type="text/javascript">

        var config = {
            type: Phaser.AUTO,
            width: 800,
            height: 600,
            physics: {
                default: 'arcade',
                arcade: {
                    gravity: false,
                    debug: false
                }
            },
            scene: {
                preload: preload,
                create: create,
                update: update
            }
        };

        var dudeid = 1;
        var players;
        let trees;
        var enemies;
        // var target;
        var vectors = [];
        var stars;
        var bombs;
        var cursors = [];
        var score = 0;
        var gameOver = false;
        var scoreText;
        var buildmode = 0;
        var statics;

        var rectangle;

        let buildicon;

        let addeddudes = 1;

        let gold = 100;
        let wood = 100;

        let goldmine;
        let buildings;


        var game = new Phaser.Game(config);

        function preload() {
            this.load.image('background', 'assets/background.png');
            this.load.image('cursor', 'assets/cursor2.png');
            this.load.image('building', 'assets/base1.png');
            this.load.image('hammer', 'assets/hammer.png');
            this.load.image('grass', 'assets/grass.png');
            this.load.image('tree', 'assets/chojka.png');
            this.load.image('goldmine', 'assets/goldmine.png');
            this.load.image('goldmine2', 'assets/goldmine2.png');






            this.load.spritesheet('dude', 'assets/dudeaxe.png', { frameWidth: 32, frameHeight: 48 });

        }



        function addDude(gameinstance, x, y, type) {

            if (!x) {
                x = Math.random() * 500;
                y = Math.random() * 500
            }


            var player = players.create(x, y, 'dude');
            player.life = 50;
            player.cost = 20;

            if (gold < player.cost) {

            }

            if (type == 'player') {
                gold -= player.cost;
                console.log(gold);
            }
            player.attackready = true;


            player.body.setBounce(0);
            player.setBounce(0);
            if (type) {
                player.type = type;
            }

            if (player.type == 'enemy') {
                player.setTint('0xff0000');
            }





            gameinstance.physics.add.existing(player);
            player.setBounce(0);
            player.setInteractive();
            player.setCollideWorldBounds(true);
            player.depth = 2;

            var vectorWithId = {
                vector: new Phaser.Math.Vector2(),
                dudeid: dudeid
            };

            var cursorWithId = {
                cursor: gameinstance.add.image(player.x, player.y, 'cursor'),
                dudeid: dudeid
            }

            cursorWithId.cursor.depth = 1;

            vectors.push(vectorWithId);
            cursors.push(cursorWithId);
            player.clicked = false;
            player.dudeid = dudeid;
            player.attacks = false;
            dudeid++;


            player.on('pointerdown', () => {
                if (!player.clicked) {
                    player.tint = '0x00ff00';
                    player.clicked = true;
                    if (player.type != 'enemy') {
                        buildicon.setVisible(true);
                    }
                } else {
                    player.tint = '0xffffff';
                    player.clicked = false;
                    buildicon.setVisible(false);
                }

            })



        }


        function addTree(x, y) {
            let tree = trees.create(x, y, 'tree');
            tree.body.immovable = true;
            tree.life = 50;
        }

        function create() {



            this.add.tileSprite(0, 0, game.config.width, game.config.height, 'grass').setOrigin(0);
            let self = this;
            this.input.mouse.disableContextMenu();
            this.pointertext = this.add.text(10, 30, '', { font: '16px Courier', fill: '#00ff00' });
            console.log(gold);
            this.goldtext = this.add.text(10, 10, 'Złoto:' + gold, { font: '16px Courier', fill: '#ffff00' });
            this.woodtext = this.add.text(100, 10, 'Drewno:' + wood, { font: '16px Courier', fill: '#FFaa00' });



            self.input.on('pointermove', (pointer) => {
                self.pointertext.setText('pozycja:' + pointer.x + ' ' + pointer.y);
            })

            buildicon = this.add.image(760, 570, 'hammer').setScale(0.5);
            buildicon.setVisible(false);
            buildicon.setInteractive();

            buildicon.on('pointerover', (pointer) => {
                self.pointertext.setText(pointer.x);
                buildicon.setTint(0xffffff);
                buildicon.setAlpha(0.8);
            })

            buildicon.on('pointerout', (pointer) => {
                buildicon.setTint(0xffffff);
                buildicon.setAlpha(1);
            })

            buildings = this.physics.add.group();
            trees = this.physics.add.group();

            //tryb budowy
            buildicon.on('pointerdown', (pointer) => {

                buildmode = 1;
                building = buildings.create(pointer.x, pointer.y, 'building');
                building.setAlpha(0.3);
                building.name = 'building';
                building.placed = false;
                building.setInteractive();
                building.setScale(0.8);
                // building.bounce = 0;
                building.body.immovable = 1;

                let collider = self.physics.add.collider(players, building, attackbase, null, self);
                collider.bounce = 0;

                //funkcjonalność budynku
                building.on('pointerdown', function (pointer) {

                    if (building.ready) {
                        addDude(self, building.x + 100, building.y + 100 - (50 * (addeddudes % 4)), 'player');
                        addeddudes += 1;
                    }
                })

                //stawianie budynku
                self.input.on('pointermove', (pointer) => {
                    if (!building.placed) {
                        building.x = pointer.x;
                        building.y = pointer.y;
                    }
                })

                //anulacja buildmode na prawy klik
                self.input.once('pointerdown', (pointer) => {
                    if (buildmode) {
                        if (pointer.rightButtonDown()) {
                            buildmode = false;
                            building.destroy();
                            return;
                        }
                    }


                })

                //stawianie budynku
                if (buildmode) {
                    self.input.once('pointerdown', function (pointer, gameObjects) {
                        console.log('działą??');
                        building.placed = true;

                        buildmode = 0;

                        self.time.addEvent({
                            delay: 3000,
                            loop: true,
                            callback: function () {
                                building.ready = 1;
                                building.setAlpha(1);


                            }
                        })

                    });

                }


                //wchodzą przeciwcniy



            })


            players = this.physics.add.group();

            this.physics.world.setBounds(0, 0, 800, 600);
            this.physics.world.gravity.y = 0;



            //go command
            this.input.on('pointerdown', (pointer) => {
                if (!buildmode) {
                    players.children.iterate((player) => {

                        if (pointer.rightButtonDown()) {
                            player.clicked = false;
                            player.tint = '0xffffff';
                            if (player.type == 'enemy') {
                                player.tint = '0xff0000';
                            }
                            buildicon.setVisible(false);

                        }
                        if (player.clicked) {

                            if (!(pointer.x > 700 && pointer.y > 530)) {
                                let target = vectors.find((el) => el.dudeid == player.dudeid).vector;
                                let cursor = cursors.find((el) => el.dudeid == player.dudeid).cursor;
                                target.x = pointer.x;
                                target.y = pointer.y;
                                cursor.x = pointer.x;
                                cursor.y = pointer.y;

                                // let vector = vectors.find((el) => el.dudeid == player.dudeid);
                                this.physics.moveToObject(player, target, 150);
                            }
                        }
                    })
                }

            });

            addDude(this, 600, 200, 'player');
            addDude(this, 400, 100, 'enemy');

            trees = this.physics.add.group();
            addTree(100, 300);
            addTree(200, 300);

            self.time.addEvent({
                delay: 10000,
                loop: true,
                callback: function () {
                    console.log('fsadfds');
                    addDude(self, 700, 50, 'enemy');
                    addTree(Math.random() * 700, Math.random() * 50);

                }
            })


            this.physics.add.collider(players, trees)

            addGoldMine(this);


            createAnimations(this);


        }


        function attackbase(building, dude) {
            dude.x += 20;
        }

        function update() {

            this.goldtext.setText('Złoto:' + gold);
            this.woodtext.setText('Drewno::' + wood);

            let self = this;

            buildicon.on('pointerup', (pointer) => {
                buildicon.setTint(0xffffff);
                buildicon.setAlpha(1);
            })


            players.children.iterate((player) => {
                goingDude(player);

            });


            players.children.each(function (player) {

                player.attacks = false;
                if (player.life <= 0) {
                    player.x = 1000;
                }

                //drzewa są zbierane
                if (player.type == 'player') {
                    trees.children.each((tree) => {
                        if (Math.abs(player.x - tree.x) < 100 && Math.abs(player.y - tree.y) < 100) {
                            tree.setTint(0xFF0000);
                            player.attacks = true;
                            if (player.attackready) {

                                if (player.body.velocity.x == 0 && player.body.velocity.y == 0) {

                                    player.attacks = true;
                                    player.attackready = false;

                                    tree.life -= 10;

                                    if (tree.life <= 0) {
                                        tree.x = 1000;
                                        player.wood = true;

                                    }
                                    console.log(tree.life);

                                    setTimeout(() => {
                                        player.attackready = true;
                                    }, 1000)
                                }
                            }

                        }
                    })
                }

                //złoto jest zbierane

                if (player.type == 'player') {
                    if (Math.abs(player.x - goldmine.x) < 100 && Math.abs(player.y - goldmine.y) < 100) {
                        if (player.body.velocity.x == 0) {
                            if (!player.gold) {
                                goldmine.setTexture('goldmine2');
                                player.gold = true;
                                player.setVelocityX(0);
                                player.setVelocityY(0);

                                player.setVisible(false);
                                setTimeout(() => {
                                    player.setVisible(true);
                                    goldmine.setTexture('goldmine');

                                }, 5000)
                            }
                        }
                    }
                }

                //player oddaje surowce
                if (player.wood || player.gold) {
                    buildings.children.each((bulding) => {
                        if (Math.abs(player.x - building.x) < 150 && Math.abs(player.y - building.y) < 150) {


                            if (player.wood) {
                                wood += 10;
                            }

                            if (player.gold) {
                                gold += 10;
                            }

                            player.wood = 0;
                            player.gold = 0;

                            console.log('ODDAJE DREWNO');

                        }

                    })
                }

                //players atakują each other
                players.children.each((another) => {
                    if (player.type != another.type) {
                        if (Math.abs(another.x - player.x) < 50 && Math.abs(another.y - player.y) < 50) {
                            player.attacks = true;

                            if (player.attackready) {

                                if (player.body.velocity.x == 0 && player.body.velocity.y == 0) {
                                    player.anims.play('axe', true);
                                    player.attacks = true;
                                    another.life -= 10;
                                    player.attackready = false;

                                    setTimeout(() => {
                                        player.attackready = true;
                                    }, 1000)
                                }
                            }

                        }
                    }
                })

                //enemy atakują budynek
                if (player) {
                    if (player.type == 'enemy') {
                        let building = self.children.getByName('building');

                        if (self.children.getByName('building')) {
                            if (player.type == 'enemy') {
                                if (building.placed) {
                                    if (player) {
                                        //  self.physics.moveToObject(player, building, 50);
                                    }
                                }
                            }
                        }
                    }
                }

            });

        }

        function goingDude(player) {

            let target = vectors.find((el) => el.dudeid == player.dudeid).vector;
            const tolerance = 4;
            const distance = Phaser.Math.Distance.Between(player.x, player.y, target.x, target.y);
            if (player.attacks) {
                player.anims.play('axe', true);
            } if (player.body.speed > 0) {
                if (target.x > player.x) {
                    player.anims.play('right', true);
                }
                if (target.x < player.x) {
                    player.anims.play('left', true);
                }
                if (distance < tolerance) {
                    player.body.reset(target.x, target.y);
                }
            } else {
                if (!player.attacks && !player.wood && !player.gold) {
                    player.anims.play('turn', true);
                }

                if (player.wood) {
                    player.anims.play('wood', true);
                }

                if (player.gold) {
                    player.anims.play('gold', true);
                }


            }

        }



        function addGoldMine(gameinstance) {
            console.log(gameinstance);
            goldmine = gameinstance.physics.add.sprite(500, 500, 'goldmine').setScale(0.5);


        }




        function createAnimations(gameinstance) {
            gameinstance.anims.create({
                key: 'turn',
                frames: [{ key: 'dude', frame: 4 }],
                frameRate: 20
            });

            gameinstance.anims.create({
                key: 'right',
                frames: gameinstance.anims.generateFrameNumbers('dude', { start: 5, end: 8 }),
                frameRate: 5,
                repeat: -1
            });

            gameinstance.anims.create({
                key: 'left',
                frames: gameinstance.anims.generateFrameNumbers('dude', { start: 0, end: 3 }),
                frameRate: 5,
                repeat: -1
            });

            gameinstance.anims.create({
                key: 'axe',
                frames: gameinstance.anims.generateFrameNumbers('dude', { start: 9, end: 11 }),
                frameRate: 5,
                repeat: -1
            });

            gameinstance.anims.create({
                key: 'wood',
                frames: [{ key: 'dude', frame: 12 }],
                repeat: -1
            });

            gameinstance.anims.create({
                key: 'gold',
                frames: [{ key: 'dude', frame: 13 }],
                repeat: -1
            });

            gameinstance.anims.create({
                key: 'gold',
                frames: [{ key: 'dude', frame: 13 }],
                repeat: -1
            });


        }







    </script>


    <script>



    </script>


</body>

</html>